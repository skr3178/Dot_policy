"use strict";(self.webpackChunksubstack=self.webpackChunksubstack||[]).push([["6247"],{57639:function(t,e,r){r.d(e,{$y:()=>v,MQ:()=>w,N9:()=>y,Nh:()=>m,RK:()=>h});var i=r(7409),l=r(94184),a=r.n(l),o=r(98661),n=r(26445),s=r(98914),d=r(60308),u=r(63651),c=r(19520),g=r(30548);let p=t=>t.attrs.fullscreen?"full":t.attrs.imageSize||"normal",v={attrs:{src:{default:""},srcNoWatermark:{default:null},fullscreen:{default:null},imageSize:{default:null},height:{default:null},width:{default:null},resizeWidth:{default:null},bytes:{default:null},alt:{default:null},title:{default:null},type:{default:null},href:{default:null},belowTheFold:{default:!1},topImage:{default:!1},internalRedirect:{default:null},isProcessing:{default:!1},align:{default:null},offset:{default:!1}},inline:!1,atom:!0,group:"block",draggable:!0,selectable:!0,isolating:!0,defining:!0,parseDOM:[{tag:"p",priority:100,getAttrs:t=>{if(t.textContent.trim())return!1;let[e]=t.getElementsByTagName("img");return!!e&&m(e)}},{tag:"img[src]",getAttrs:t=>!(t.getAttribute("height")&&1>=Number(t.getAttribute("height"))||t.getAttribute("width")&&1>=Number(t.getAttribute("width")))&&m(t)}],toDOM:t=>{let{ImageActions:e}=r(55918);try{let r,i,l;let s=f(t),c=p(t),g=d.s2v.map(e=>({width:e,imageSrc:f(t,{maxWidth:e})})),v=d.s2v.map(e=>({width:e,imageSrc:f(t,{maxWidth:e,imageProps:{format:"webp"}})})),{isProcessing:h}=t.attrs;t.attrs.height&&t.attrs.width&&(r=t.attrs.height,i=t.attrs.width,t.attrs.resizeWidth?(r=t.attrs.resizeWidth*r/i,i=t.attrs.resizeWidth):_(t.attrs)&&i<d.kPM&&(r*=d.kPM/i,i=d.kPM),"full"===c&&(i=Math.min(i,d.qN9)));let m=t.attrs.width/t.attrs.height,y=t.attrs.resizeWidth?t.attrs.resizeWidth/m:t.attrs.height,b=t.attrs.resizeWidth?t.attrs.resizeWidth/y:m,w=!(t.attrs.href&&t.attrs.href!=t.attrs.src);w=(w=w&&t.attrs.height>240&&y>240)&&m<4&&b<4;let k="undefined"==typeof window;l=t.attrs.href?(0,u.chL)(t.attrs.href)?(0,d.zF4)(t.attrs.href):t.attrs.href:(0,d.zF4)(t.attrs.src);let $=document.createElement("div");if(w&&k){$.className="image-link-expand";try{$.innerHTML=(0,n.Dq)((0,o.createElement)(e,{size:20}))}catch(t){console.error("Error rendering ImageActions",t)}}return["a",{class:a()("image-link image2","left"===t.attrs.align&&"image2-align-left","right"===t.attrs.align&&"image2-align-right",t.attrs.offset&&"left"===t.attrs.align&&"image2-offset-left",t.attrs.offset&&"right"===t.attrs.align&&"image2-offset-right",w&&"is-viewable-img",h&&"processing"),target:"_blank",href:l,"data-component-name":"Image2ToDOM"},["div",{class:"image2-inset".concat("full"===c?" image2-full-screen":"")},["picture",{},["source",{type:"image/webp",srcset:v.map(t=>"".concat(t.imageSrc," ").concat(t.width,"w")).join(", "),sizes:"100vw"}],["img",{src:s,width:"full"===c?void 0:i,height:"full"===c?void 0:r,"data-attrs":JSON.stringify(t.attrs),class:"full"===c?"sizing-fullscreen":"large"===c?"sizing-large":"sizing-normal",alt:t.attrs.alt||"",title:t.attrs.title||t.attrs.alt,srcset:g.map(t=>"".concat(t.imageSrc," ").concat(t.width,"w")).join(", "),sizes:"100vw",loading:t.attrs.belowTheFold?"lazy":null,fetchpriority:t.attrs.topImage?"high":null}]],$]]}catch(e){return console.error("Error rendering Maximize2",e),(0,c.s)({msg:null,node:t,err:e,group:"block"})}},toDOMStatic:t=>{var e,r;let i=p(t),l=t.attrs.href||t.attrs.internalRedirect||(0,d.zF4)(t.attrs.src,void 0,{quality:"normal"===i?"auto:good":"auto:best"});if(t.attrs.height&&t.attrs.width&&"full"!==i){let{width:e,height:r}=t.attrs,i=e;t.attrs.resizeWidth?i=t.attrs.resizeWidth:_(t.attrs)&&(i=Math.min(Math.max(e,d.kPM),d.JWy));let a=Math.min(i,d.bxL),o=r*a/e,n=i>d.bxL,s={"data-attrs":JSON.stringify(t.attrs),alt:t.attrs.alt||"",title:t.attrs.title||t.attrs.alt,width:a,height:o,class:n?"wide-image":"",src:(0,d.zF4)(t.attrs.src,Math.min(!_(t.attrs)&&n?2*i:i,2*d.bxL),{lossy:k(t.attrs)})};return["table",{class:"image-wrapper",width:"100%",border:"0",cellSpacing:"0",cellPadding:"0","data-component-name":"Image2ToDOMStatic"},["tr",{},["td"],["td",{align:"left",class:"content",width:i},["a",{class:"image-link",target:"_blank",href:l},["img",s]]],["td"]]]}return"full"===i?["a",{class:"image-link",target:"_blank",href:l},["img",{src:(0,d.zF4)(t.attrs.src,2*d.bxL,{lossy:k(t.attrs),crop:"limit",aspect:"full"===i?"1":void 0}),"data-attrs":JSON.stringify(t.attrs),alt:t.attrs.alt||"",title:t.attrs.title||t.attrs.alt,height:t.attrs.height,width:t.attrs.width}]]:["a",{class:"image-link",target:"_blank",href:l},["img",{src:(0,d.zF4)(t.attrs.src,2*d.bxL,{lossy:k(t.attrs)}),"data-attrs":JSON.stringify(t.attrs),alt:t.attrs.alt||"",title:t.attrs.title||t.attrs.alt,width:t.attrs.resizeWidth||t.attrs.width,height:t.attrs.resizeWidth?(e=t.attrs.width,r=t.attrs.height,r*t.attrs.resizeWidth/e):t.attrs.height}]]}},h=(0,g.S)({name:"image2",nodeSpec:v}),m=function(t,e){let r,i,l,{bytes:a,internalRedirect:o}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=t.getAttribute("data-attrs");if(n)try{return JSON.parse(n)}catch(t){}t.getAttribute("imageSize")&&(r=t.getAttribute("imageSize"));let s=t.getAttribute("style");if(s){let t=/max-height:\s*(\d+)px/.exec(s);t&&(i=Number(t[1]));let e=/max-width:\s*(\d+)px/.exec(s);e&&(l=Number(e[1]))}else t.getAttribute("width")&&t.getAttribute("height")&&(i=Number(t.getAttribute("height")),l=Number(t.getAttribute("width")));return t.complete&&t.naturalHeight&&t.naturalWidth&&(i=t.naturalHeight,l=t.naturalWidth),{src:(0,d.UH4)(t.getAttribute("data-medium-file")||t.getAttribute("src")),type:e,title:t.getAttribute("title"),alt:t.getAttribute("alt"),height:i,width:l,bytes:a,internalRedirect:o,imageSize:r,href:t.getAttribute("href"),align:t.getAttribute("align"),offset:"true"===t.getAttribute("offset")}},f=function(t){let{maxWidth:e=null,imageProps:r={}}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=p(t),a="full"===l?2*d.hI6:"large"===l?2*d.urw:2*d.qN9;return e&&(a=Math.min(e,a)),(0,d.zF4)(t.attrs.src,a,(0,i._)({lossy:k(t.attrs)},r))},y=function(t){var e;let{customSchema:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(r&&!r.nodes.image2)return null;let i=/(https?:\/\/(giphy\.com\/gifs|gph.is\/g|media\d*\.giphy\.com\/media)\/[^\s]+)/.exec(t);return null!==(e=i&&i[1])&&void 0!==e?e:null},b=async t=>{let e=(await Promise.resolve().then(r.t.bind(r,80569,23))).default,i="image/gif",l=await e.get("/api/v1/giphy").query({url:t});return m(await new Promise(t=>(0,s.pt)(f({attrs:{type:i,src:l.body.url}}),t)),i,{bytes:l.body.bytes})},w=async function(t){let{customSchema:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(e?{schema:e}:await Promise.resolve().then(r.bind(r,37175))).schema.nodes.image2.create(await b(t))};function k(t){return _(t)&&(!t.bytes||t.bytes>5e6)}function _(t){return!!(t.type&&"image/gif"===t.type||t.src&&t.src.split("?")[0].split("#")[0].endsWith(".gif"))}},37175:function(t,e,r){r.r(e),r.d(e,{EMPTY_DOC:()=>ev,HEADER_IMAGE_ATTRS_FROM_NODE_TYPE:()=>eh,addIdsToHeaders:()=>eB,checkForUnpublishableComments:()=>e3,checkForUnsafeLinks:()=>e9,createStringDoc:()=>rt,customMediaNodes:()=>ef,extractTags:()=>eq,fromHtml:()=>eH,getCoverImage:()=>eY,getCoverImages:()=>e0,getDefaultPodcastDescriptionWithoutFeedCTAs:()=>e7,getDescription:()=>eZ,getDimensionsFromImageUrl:()=>ep,getFirstImageFromBody:()=>eK,getHeaderImageFromBody:()=>eQ,getImageUrlsFromPostBody:()=>eX,getImagesFromBody:()=>eG,getLinks:()=>e4,getPreviewImageUrl:()=>e1,hasExplicitPaywall:()=>re,migrateMarkdown:()=>eV,migratePost:()=>eR,migrateProsemirrorToTiptap:()=>eI,migratePublication:()=>ej,migrateTiptapToProsemirror:()=>eM,nodeToHtml:()=>eP,normalizeDbPodcastDescriptionToHtmlString:()=>e6,purgeUnsafeLinks:()=>e8,schema:()=>ek,schemaStatic:()=>e_,serializeDoc:()=>eC,serializedToPodcastDescription:()=>eU,setBelowTheFoldAttribute:()=>e5,setButtonActions:()=>e2,tipTapNodes:()=>eA,tipTapSchema:()=>eO,toHtml:()=>eL,toText:()=>eJ,trackedCustomNodes:()=>eb,unserializeDoc:()=>eD,unserializeDocAsync:()=>eE,unserializeJson:()=>eW});var i=r(7409),l=r(99282),a=r(88897),o=r(19512),n=r(56070),s=r(18490),d=r(24717),u=r(56782),c=r(43557),g=r(99961),p=r(18e3),v=r(51127),h=r(67338),m=r(75481),f=r(55786),y=r(32018),b=r(91077),w=r(87597),k=r(94886),_=r(99218),$=r(55963),z=r(21803),x=r(76405),S=r(39693),N=r.n(S),A=r(14293),O=r.n(A),T=r(44908),F=r.n(T),I=r(60826),M=r(24791),W=r(40121),D=r(5889),E=r(60308),C=r(84864),P=r(5835),B=r(26603),L=r(57937),J=r(55633),U=r(1451),q=r(44262),H=r(41676),V=r(82032),R=r(95068),j=r(99605),Z=r(12568),Y=r(65626),G=r(37622),K=r(36621),Q=r(31188),X=r(71993),tt=r(88954),te=r(13991),tr=r(36122),ti=r(72270),tl=r(82167),ta=r(47456),to=r(32978),tn=r(40924),ts=r(86725),td=r(59383),tu=r(5660),tc=r(1415),tg=r(98616),tp=r(82708),tv=r(73984),th=r(11105),tm=r(10218),tf=r(98738),ty=r(81519),tb=r(59662),tw=r(60511),tk=r(75837),t_=r(29961),t$=r(24653),tz=r(80334),tx=r(94413),tS=r(75970),tN=r(715),tA=r(87113),tO=r(71766),tT=r(98450),tF=r(87413),tI=r(69323),tM=r(61601),tW=r(57639),tD=r(54793),tE=r(29511),tC=r(49640),tP=r(99975),tB=r(41128),tL=r(23431),tJ=r(73078),tU=r(85197),tq=r(53797),tH=r(99741),tV=r(3185),tR=r(8220),tj=r(18119),tZ=r(44288),tY=r(13938),tG=r(54757),tK=r(11006),tQ=r(11470),tX=r(66928),t0=r(19805),t1=r(46393),t2=r(2107),t4=r(99149),t3=r(79592),t9=r(62645),t8=r(39111),t5=r(42034),t6=r(41505),t7=r(57950),et=r(78483),ee=r(57881),er=r(84766),ei=r(62092),el=r(68303),ea=r(88956),eo=r(22498),en=r(22365),es=r(60802),ed=r(45913),eu=r(12076),ec=r(34612),eg=r(32751);let ep=t=>{var e,r,i,l;let[a,o]=((null===(l=t.split("_"))||void 0===l?void 0:null===(i=l[1])||void 0===i?void 0:null===(r=i.split("."))||void 0===r?void 0:null===(e=r[0])||void 0===e?void 0:e.split("x"))||[0,0]).map(Number);return{width:a||0,height:o||0}},ev={type:"doc",content:[{type:"paragraph"}]},eh={captionedImage:t=>{var e,r,i,l;let a=null===(e=t.content)||void 0===e?void 0:e.find(t=>{var e,r;return"image2"===t.type&&(null===(e=t.attrs)||void 0===e?void 0:e.width)>=300&&(null==t?void 0:null===(r=t.attrs)||void 0===r?void 0:r.height)>=300});if(!a)return{url:null,caption:void 0,alt:void 0};let o=null==t?void 0:null===(r=t.content)||void 0===r?void 0:r.find(t=>"caption"===t.type);return{url:null==a?void 0:null===(i=a.attrs)||void 0===i?void 0:i.src,caption:o,alt:null==a?void 0:null===(l=a.attrs)||void 0===l?void 0:l.alt}},image2:t=>{var e,r,i,l;return"number"!=typeof(null===(e=t.attrs)||void 0===e?void 0:e.width)&&"number"!=typeof(null===(r=t.attrs)||void 0===r?void 0:r.height)||t.attrs.width>=300&&t.attrs.height>=300?{url:null==t?void 0:null===(i=t.attrs)||void 0===i?void 0:i.src,alt:null==t?void 0:null===(l=t.attrs)||void 0===l?void 0:l.alt}:{url:null,caption:void 0,alt:void 0}},image3:t=>{var e,r,i,l,a;let o=ep(null===(e=t.attrs)||void 0===e?void 0:e.src);return"number"!=typeof(null===(r=t.attrs)||void 0===r?void 0:r.width)&&"number"!=typeof(null===(i=t.attrs)||void 0===i?void 0:i.height)||t.attrs.width>=300&&t.attrs.height>=300||o.width>=300&&o.height>=300?{url:null===(l=t.attrs)||void 0===l?void 0:l.src,caption:t.content,alt:null===(a=t.attrs)||void 0===a?void 0:a.alt}:{url:null,caption:void 0,alt:void 0}}},em={image:t=>{var e;return e1(null===(e=t.attrs)||void 0===e?void 0:e.src)},image2:t=>{var e,r,i;return"number"!=typeof(null===(e=t.attrs)||void 0===e?void 0:e.width)&&"number"!=typeof(null===(r=t.attrs)||void 0===r?void 0:r.height)||t.attrs.width>=300&&t.attrs.height>=300?e1(null===(i=t.attrs)||void 0===i?void 0:i.src):null},image3:t=>{var e,r,i,l;let a=ep(null===(e=t.attrs)||void 0===e?void 0:e.src);return"number"!=typeof(null===(r=t.attrs)||void 0===r?void 0:r.width)&&"number"!=typeof(null===(i=t.attrs)||void 0===i?void 0:i.height)||t.attrs.width>=300&&t.attrs.height>=300||a.width>=300&&a.height>=300?e1(null===(l=t.attrs)||void 0===l?void 0:l.src):null},imageGallery:t=>{var e,r,i;return e1(null===(i=t.attrs)||void 0===i?void 0:null===(r=i.gallery.images)||void 0===r?void 0:null===(e=r[0])||void 0===e?void 0:e.src)},spotify:t=>{var e;return e1(null===(e=t.attrs)||void 0===e?void 0:e.image)},spotify2:t=>{var e;return e1(null===(e=t.attrs)||void 0===e?void 0:e.image)},opensea:t=>{var e;return e1(null===(e=t.attrs)||void 0===e?void 0:e.image)},twitter2:t=>{var e,r;if(null===(e=t.attrs)||void 0===e?void 0:e.photos){for(let e of t.attrs.photos)if(e.img_url)return e1(e.img_url)}return(null===(r=t.attrs)||void 0===r?void 0:r.expanded_url)&&t.attrs.expanded_url.image?t.attrs.expanded_url.image.url?e1(t.attrs.expanded_url.image.url):e1(t.attrs.expanded_url.image):null},vimeo:t=>{var e;return ed.Jn(null===(e=t.attrs)||void 0===e?void 0:e.videoId,{playButton:!1})},youtube:t=>{var e;return eg.Jn(null===(e=t.attrs)||void 0===e?void 0:e.videoId,{playButton:!1})},youtube2:t=>{var e;return eg.Jn(null===(e=t.attrs)||void 0===e?void 0:e.videoId,{playButton:!1})},kindle:t=>{var e;return(0,E.zF4)(null===(e=t.attrs)||void 0===e?void 0:e.imageUrl)},applePodcast:t=>{var e;return(0,E.zF4)(null===(e=t.attrs)||void 0===e?void 0:e.imageUrl)},tiktok:t=>{var e;return(0,E.zF4)(null===(e=t.attrs)||void 0===e?void 0:e.thumbnail_url)},prediction_market:t=>{var e;return(0,E.zF4)(null===(e=t.attrs)||void 0===e?void 0:e.thumbnail_url)},manifold:t=>{var e;return(0,E.zF4)(null===(e=t.attrs)||void 0===e?void 0:e.thumbnail_url)},lichess:t=>{var e;return(0,E.zF4)(null===(e=t.attrs)||void 0===e?void 0:e.thumbnail_url)},datawrapper:t=>{var e;return(0,E.zF4)(null===(e=t.attrs)||void 0===e?void 0:e.thumbnail_url)},pinterest:t=>{var e;return e1(null===(e=t.attrs)||void 0===e?void 0:e.image)}},ef={augmentation_placeholder:U.$,youtube2:eg.$y,youtube:ec.$,vimeo:ed.$y,install_substack_app:tC.$,preview_in_substack_app:tG.$,opensea:tq.$y,twitter2:er.$y,twitter:ee.$,communityChat:tt.$y,communityPost:te.$y,comment:X.$y,spotify2:t3.$y,spotify:t4.$,soundcloud:t1.$y,instagram:tE.$y,image2:tW.$y,image:tI.$,button:R.$y,comic:Q.Z.nodeSpec,file:Q.Z.nodeSpec,pdf:tV.Z.nodeSpec,xlsx:eu.Z.nodeSpec,ebook:to.Z.nodeSpec,referral_link:tX.$,bandcamp:q.$y,kindle:tP.$y,gitgist:tF.$y,embeddedPost:tn.$y,embeddedPublication:ts.$y,applePodcast:P.$y,audio:L.$y,video:es.$,audioUrl:J.$y,tiktok:et.$y,bluesky:V.$y,poll:tj.$,sponsorshipCampaign:t2.$,imageGallery:tM.$y,image3:tD.$y,cashtag:K.$,substack_mentions:tU.$,prediction_market:tZ.$y,manifold:tZ.$y,lichess:tL.$y,datawrapper:ti.$y,digestPostEmbed:tl.$y,assetError:B.$,directMessage:ta.$y,recipe:tQ.$,pinterest:tR.$y},ey=(0,l._)((0,i._)({},ef),{blockquote:H.$,calloutBlock:j.$,fragmentNode:tT.$,captionedImage:G.$,caption:Z.$,ctaCaption:tr.$,footnote:tN.$,footnoteAnchor:tA.$,latex_block:tB.$y,paywall:tH.$,preformatted_text_block:tY.$,pullquote:tK.$,subscribeWidget:t8.$,captionedShareButton:(0,Y.$y)({url:I.W.SHARE_URL}),captionedWriterReferralButton:(0,Y.$y)({hasDynamicSubstitutions:!1}),templateComment:t7.$,meeting:tJ.$,referralTier:t0.$y,fpRecircBlock:tO.$y}),eb=(0,l._)((0,i._)({},ef),{subscribeWidget:t8.$,paywall:tH.$,templateComment:t7.$}),ew={strikethrough:t9.J,superscript:t6.O,subscript:t5.l},ek=new x.V_({nodes:eT(),marks:eF()}),e_=new x.V_({nodes:eT({isStatic:!0}),marks:eF({isStatic:!0})}),e$=Object.keys(ey).filter(t=>!["blockquote","pullquote","calloutBlock","fpRecircBlock"].includes(t)).map(t=>{let e=(0,el.Co)(t,ey[t]),r=(0,i._)({},ey[t],e);return"youtube2"===t?r.addNodeView=()=>t=>{let{node:e}=t;return new eg.dQ(e)}:"tiktok"===t?r.addNodeView=()=>t=>{let{node:e}=t;return new et.QZ(e)}:"lichess"===t?r.addNodeView=()=>t=>{let{node:e}=t;return new tL.$1(e)}:"datawrapper"===t?r.addNodeView=()=>t=>{let{node:e}=t;return new ti.s3(e)}:"prediction_market"===t||"manifold"===t?r.addNodeView=()=>t=>{let{node:e}=t;return new tZ.eC(e)}:"paywall"===t?r.addNodeView=()=>t=>new tH.b:"latex_block"===t?r.addNodeView=()=>t=>{let{node:e}=t;return new tB.Jd(e)}:"comic"===t?r.addNodeView=()=>t=>{let{node:e,editor:r,getPos:i}=t;return Q.Z.getNodeView({node:e,editor:r,getPos:i})}:"pdf"===t?r.addNodeView=()=>t=>{let{node:e,editor:r,getPos:i}=t;return tV.Z.getNodeView({node:e,editor:r,getPos:i})}:"xlsx"===t?r.addNodeView=()=>t=>{let{node:e,editor:r,getPos:i}=t;return eu.Z.getNodeView({node:e,editor:r,getPos:i})}:"ebook"===t&&(r.addNodeView=()=>t=>{let{node:e,editor:r,getPos:i}=t;return to.Z.getNodeView({node:e,editor:r,getPos:i})}),a.NB.create(r)}),ez=o.V6.extend({addCommands(){return{toggleBlockquote:()=>t=>{let{state:e,commands:r}=t;return!(!(0,a.Ig)(e,"paragraph")||(0,a.Ig)(e,"pullquote")||(0,a.Ig)(e,"calloutBlock"))&&r.toggleWrap(this.name)}}},parseHTML:()=>H.$.parseDOM}),ex=o.V6.extend({name:"calloutBlock",addCommands(){return{toggleCalloutBlock:()=>t=>{let{state:e,commands:r}=t;if((0,a.Ig)(e,"calloutBlock"))return r.lift("calloutBlock");if((0,a.Ig)(e,"paragraph")||(0,a.Ig)(e,"button"))return!((0,a.Ig)(e,"pullquote")||(0,a.Ig)(e,"blockquote"))&&r.toggleWrap(this.name);let i=[e.schema.nodes.paragraph,e.schema.nodes.button].filter(t=>!!t),l=!0;return e.doc.nodesBetween(e.selection.from,e.selection.to,(t,r,a,o)=>{if(a===e.doc&&(t.type===e.schema.nodes.blockquote||t.type===e.schema.nodes.pullquote||!i.includes(t.type)))return l=!1,!1}),!(!l||(0,a.Ig)(e,"pullquote")||(0,a.Ig)(e,"blockquote"))&&r.toggleWrap(this.name)}}},parseHTML:()=>[{tag:"div[data-callout]",priority:100},{tag:"div.callout-block",priority:99}],renderHTML:()=>["div",{class:"callout-block","data-callout":"true"},0]}),eS=h.b.extend({addCommands:()=>({insertHorizontalRule:()=>t=>{let{state:e,dispatch:r}=t;return r&&e.schema.nodes.horizontalRule&&r((0,el.o4)(e,e.schema.nodes.horizontalRule.create())),!0},setHorizontalRule:()=>t=>{let{state:e,dispatch:r}=t;if(r){if(!e.schema.nodes.horizontalRule)return console.error("horizontalRule is missing"),!1;r((0,el.o4)(e,e.schema.nodes.horizontalRule.create()))}return!0}})}),eN=u.dn.extend({marks:"_"}),eA=[ez,n.d8,s.DY,tu.z,ex,d.EK,eN,tg.l,c.B,tv.w,g.U,p.X,v.A,eS,td.M,tS.f,tm._,ty.r,tk.q,tz.a,t_.R,tw.q,th.y,m.Tx,tf.d,f.H,y.GS,b.n,tb.f,tK.z,w.Re,k.a,_.$,$.x,tc.n,tx.T,tp.k,ta.e1,tO.t_,...e$],eO=(0,a.J1)(eA);function eT(){let{isStatic:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=z.fK.spec.nodes;for(let r of Object.keys(ey)){let i=Object.assign({},ey[r]);t&&i.toDOMStatic&&(i.toDOM=i.toDOMStatic),delete i.toDOMStatic,e=e.get(r)?e.update(r,i):e.addToEnd(r,i)}return e}function eF(){let{isStatic:t=!1}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=z.fK.spec.marks;for(let r of Object.keys(ew)){let i=Object.assign({},ew[r]);t&&i.toDOMStatic&&(i.toDOM=i.toDOMStatic),delete i.toDOMStatic,e=e.get(r)?e.update(r,i):e.addToEnd(r,i)}return e}function eI(t){let{postId:e,pubId:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t;return"string"==typeof i&&(i=eW(i,{postId:e,pubId:r})),(0,el.cb)(i,t=>{let e=el.qj.find(e=>e[0]===t.type);return e&&(t.type=e[1],t.attrs&&"orderedList"===e[1]&&(t.attrs.start=t.attrs.order)),t.marks&&t.marks.forEach(t=>{let e=el.PH.find(e=>e[0]===t.type);e&&(t.type=e[1])}),t}),i}function eM(t){let{postId:e,pubId:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=t;return"string"==typeof i&&(i=eW(i,{postId:e,pubId:r})),(0,el.cb)(i,t=>{let e=el.qj.find(e=>e[1]===t.type);return e&&(t.type=e[0],t.attrs&&"ordered_list"===e[0]&&(t.attrs.order=t.attrs.start)),t.marks&&t.marks.forEach(t=>{let e=el.PH.find(e=>e[1]===t.type);e&&(t.type=e[0])}),t}),i}function eW(t){let e,{postId:r,pubId:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t&&(t=(t=t.replace("http://substack-post-media","https://substack-post-media")).replace("http://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984","https://bucketeer-e05bbc84-baa3-437e-9518-adb32be77984")),t=eV(t))try{e=JSON.parse(t)}catch(e){console.error("unserializeJson for post [".concat(r,"], pubId [").concat(i,"], could not parse serialized:"),t,e)}return null!=e?e:void 0}function eD(t){let{customSchema:e,useTiptap:r,mutateJson:i,shouldSetBelowTheFoldAttribute:l=!1,shouldThrowOnInvalid:a,postId:o,pubId:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let a=eW(t,{postId:o,pubId:n})||ev;i&&i(a);let s=e8(a);if(!s)throw Error("could not purgeUnsafeLinks");let d=s;return l&&(d=e5(d)),d=r?eI(d,{postId:o,pubId:n}):eM(d,{postId:o,pubId:n}),(e||ek).nodeFromJSON(d)}catch(r){if(console.error("Failed to parse JSON for post [".concat(o,"], serialized:"),t,r),a)throw Error("Failed to parse JSON:  ".concat(r.message));return(e||ek).nodeFromJSON(ev)}}async function eE(t){let{customSchema:e,useTiptap:r,mutateJson:i,shouldSetBelowTheFoldAttribute:l=!1,shouldThrowOnInvalid:a,postId:o,pubId:n}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{let a=eW(t,{postId:o,pubId:n})||ev;i&&await i(a);let s=e8(a);if(!s)throw Error("could not purgeUnsafeLinks");let d=s;return l&&(d=e5(d)),d=r?eI(d,{postId:o,pubId:n}):eM(d,{postId:o,pubId:n}),(e||ek).nodeFromJSON(d)}catch(r){if(console.error("Failed to parse JSON for post [".concat(o,"], serialized:"),t,r),a)throw Error("Failed to parse JSON:  ".concat(r.message));return(e||ek).nodeFromJSON(ev)}}function eC(t){let{runMigrations:e=!1,postId:r,pubId:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=t.toJSON();return e&&(l=eM(l=e8(l=function(t){let{postId:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r="string"==typeof t?eW(t,{postId:e}):t;return(0,el.cb)(r,t=>{t.text&&(t.text=(0,C.stripInvalidBytes)(t.text))},{nodeTypes:["text"]}),r}(l)),{postId:r,pubId:i})),JSON.stringify(l)}function eP(t,e){let r=document.createElement("div");return r.appendChild(x.PW.fromSchema(e?e_:ek).serializeFragment(x.HY.fromArray([t]),{document})),r}function eB(t){Array.from(t.querySelectorAll("h2, h3, h4, h5, h6")).forEach(t=>{if(!t.getAttribute("id")){var e,r;let i=(r=t.textContent||"",(0,W.Hm)((0,C.truncateText)(r,500,{ellipsis:""}),{allowUnicode:!0})),l=document.createElement("div");l.setAttribute("id",i),l.setAttribute("class","anchor-target"),null===(e=t.parentNode)||void 0===e||e.insertBefore(l,t);let a=document.createElement("a");for(a.setAttribute("href","#".concat(i));t.firstChild;)a.appendChild(t.firstChild);t.appendChild(a)}})}function eL(t,e){let{isAmp:r,transform:i,useTipTap:l,pubId:a,postId:o}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(l){let r=eI(eW(t,{postId:o,pubId:a}),{postId:o,pubId:a});if(!r)throw Error("could not serialize json doc");return(0,en.e)({doc:r,extensions:(0,t$.p)({isStatic:null!=e&&e}),customDocument:document})}let n=eD(t,{shouldSetBelowTheFoldAttribute:!0,postId:o,pubId:a}),s=x.PW.fromSchema(e?e_:ek),d=document.createElement("div");try{s.serializeFragment(n.content,{document},d)}catch(t){return console.error("could not serialize fragment, for pubId [".concat(a,"], postId [").concat(o,"]"),t),d.innerHTML}return i&&i(d),r&&function(t){Array.from(t.querySelectorAll("img")).forEach(t=>{let e=document.createElement("amp-img");e.setAttribute("layout","intrinsic"),t.getAttributeNames().forEach(r=>{var i;"srcset"!==r&&e.setAttribute(r,null!==(i=t.getAttribute(r))&&void 0!==i?i:"null")}),t.replaceWith(e)})}(d),d.innerHTML}function eJ(t,e){let{postId:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return(0,el.lr)(eD(t,{postId:r}),e)}function eU(t){let{postId:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,el.fX)(eD(t,{postId:e}))}function eq(t){let{postId:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return(0,el.E5)(eD(t,{postId:e}))}function eH(t){let{stripEmptyParagraphs:e,postId:r,pubId:i}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=x.aw.fromSchema(ek).parse(new DOMParser().parseFromString(t,"text/html"));return(e&&(l=(0,ea.Y)(l,t=>!t.type||"paragraph"!==t.type.name||!!(0,el.lr)(t))),l)?eC(l,{postId:r,pubId:i}):null}function eV(t){return t&&"{"!==t[0]&&"null"!==t?eC(z.EU.parse(t)):t}function eR(t){var e,r;return t.body=null!==(e=eV(t.body))&&void 0!==e?e:null,t.draft_body=null!==(r=eV(t.draft_body))&&void 0!==r?r:null,t}function ej(t){var e,r,i,l,a;return t.subscribe_content=null!==(e=eV(t.subscribe_content))&&void 0!==e?e:null,t.welcome_email_content=null!==(r=eV(t.welcome_email_content))&&void 0!==r?r:null,t.tos_content=null!==(i=eV(t.tos_content))&&void 0!==i?i:null,t.privacy_content=null!==(l=eV(t.privacy_content))&&void 0!==l?l:null,t.disclosures_content=null!==(a=eV(t.disclosures_content))&&void 0!==a?a:null,t}function eZ(t,e){let{post:r=null,pubId:i,minCharacters:l=6,maxStopAfter:a=null,singleSentence:o=!0,language:n="en",excludeMediaPrefix:s=!1}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},{iString:d}=I18N.i(n),u=(null==r?void 0:r.type)==="thread"?145:250;(a||0===a)&&(u=Math.min(a,u));let c=(null==r?void 0:r.type)==="thread",g="";if(e)g+=e;else if(0!==u){var p;let e={paragraph:!0,blockquote:!0,list_item:!0,listItem:!0,heading:!0,code_block:!0,codeBlock:!0,hardbreak:!0,hard_break:!0,hardBreak:!0},a={caption:!0,footnote:!0};(0,el.cb)("string"==typeof t?eW(t,{postId:null!==(p=null==r?void 0:r.id)&&void 0!==p?p:null,pubId:i}):t,t=>{if(u&&g.length>=u||t.type&&a[t.type])return!1;if("text"===t.type){let{text:e}=t;if(e){let t=e.match(/[.?!] /);if(o&&(null==t?void 0:t.index))return g+=e.slice(0,t.index+1),eo.aT;g+=e}}else if(t.type&&e[t.type]&&g){if(g.length>l)return eo.aT;" "!==g[g.length-1]&&(g+=" ")}else if("substack_mentions"===t.type){var r,i;g+=null!==(i=null===(r=t.attrs)||void 0===r?void 0:r.name)&&void 0!==i?i:""}})}if(g=g.replace(/\s+/g," ").trim(),c&&u&&g.length>=u&&(g=(0,C.truncateText)(g,u)),((null==r?void 0:r.type)==="podcast"||(null==r?void 0:r.type)==="video")&&!s){let t=(0,M.XV)(r);g="".concat(d((null==r?void 0:r.type)==="video"||(null==r?void 0:r.videoUpload)?"Watch now":"Listen now")," ").concat(t?"(".concat((0,C.secondsToLargestUnit)(t,{minutesCutoff:10800,language:n}),") "):"","| ").concat(g)}return g}function eY(t,e){var r;return null!==(r=e0(t,e)[0])&&void 0!==r?r:null}function eG(t){let{postId:e,pubId:r,width:i,height:l}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=eW(t,{postId:e,pubId:r});return a?F()(N()((0,el.fp)(a,t=>{var e;return!!em[null!==(e=t.type)&&void 0!==e?e:""]}).map(t=>{var e,r;let a=null===(e=em[null!==(r=t.type)&&void 0!==r?r:""])||void 0===e?void 0:e.call(em,t);return a?(0,E.zF4)(a,i,{height:l}):null}))):[]}function eK(t){let{postId:e,pubId:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=eG(t,{postId:e,pubId:r});return i.length>0&&!O()(i[0])?i[0]:null}function eQ(t){let{body:e}=t,r=eW(e);if(r)return(0,el.fp)(r,t=>{var e;return!!eh[null!==(e=t.type)&&void 0!==e?e:""]}).map(t=>{var e,r;return null===(e=eh[null!==(r=t.type)&&void 0!==r?r:""])||void 0===e?void 0:e.call(eh,t)})[0]}async function eX(t){let{body:e,postId:r}=t,i=eD(e,{postId:r}),l=[];return(0,el.je)(i,t=>{switch(t.type.name){case"image":case"image2":t.attrs.src&&l.push(t.attrs.src);break;case"imageGallery":var e;null===(e=t.attrs.gallery.images)||void 0===e||e.map(t=>{t.src&&l.push(t.src)})}}),l}function e0(t,e){var r;let i=[];"podcast_episode_image_info"in e&&e.podcast_episode_image_info&&!e.podcast_episode_image_info.isDefaultArt&&i.unshift(e.podcast_episode_image_info.url),i.unshift(...eG(t,{postId:e.id}));let l="podcastUpload"in e&&e.podcastUpload||"draftPodcastUpload"in e&&e.draftPodcastUpload||void 0;if((null==l?void 0:l.state)==="transcoded"&&(null!==(r=null==l?void 0:l.thumbnail_id)&&void 0!==r?r:1)>1){let t=(0,E.ow1)(l);t&&i.unshift(t)}let a="videoUpload"in e&&e.videoUpload||"draftVideoUpload"in e&&e.draftVideoUpload||void 0;if((null==a?void 0:a.state)==="transcoded"){let t=(0,E.ow1)(a);t&&i.unshift(t)}return"podcast_art_url"in e&&e.podcast_art_url&&i.unshift(e.podcast_art_url),i}function e1(t){return"string"!=typeof t?null:(t=t.replace(/\/l_twitter_play_button_rvaygk[^/]+/g,""),(0,E.zF4)(t,void 0,{height:600}))}function e2(t){(0,el.cb)(t,t=>{var e;return"button"===t.type&&((null===(e=t.attrs)||void 0===e?void 0:e.url)&&"string"==typeof t.attrs.url&&t.attrs.url.startsWith("%%")&&(t.attrs.action=t.attrs.url.replace(/%%/g,"")),!0)},{nodeTypes:"button"})}function e4(t){let{postId:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=t;if("string"==typeof r){let t=eW(r,{postId:e});if(!t)return[];r=t}e2(r);let i=[];return(0,el.cb)(r,t=>{var e,r,l;if("button"===t.type&&(null===(e=t.attrs)||void 0===e?void 0:e.url)&&!t.attrs.action)i.push({text:t.attrs.text,url:t.attrs.url});else if("image2"===t.type&&(null===(r=t.attrs)||void 0===r?void 0:r.href))i.push({text:t.attrs.href,url:t.attrs.href});else if(t.marks){for(let e of t.marks)if("link"===e.type&&(null===(l=e.attrs)||void 0===l?void 0:l.href)){i.push({text:t.text,url:e.attrs.href});break}}}),i}function e3(t){let{postId:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return!1;let r=t;if("string"==typeof r){let t=eW(r,{postId:e});if(!t)return!1;r=t}return!!(0,el.DY)(r,t=>"templateComment"===t.type)}function e9(t){let{postId:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return!1;let r=t;if("string"==typeof r){let t=eW(r,{postId:e});if(!t)return!1;r=t}return!!(0,el.DY)(r,t=>{for(let n of["href","src","url"]){var e,r,i,l,a,o;if((null==t?void 0:null===(l=t.attrs)||void 0===l?void 0:null===(i=l[n])||void 0===i?void 0:null===(r=i.trim)||void 0===r?void 0:null===(e=(a=r.call(i)).toLowerCase)||void 0===e?void 0:e.call(a).startsWith("javascript:"))||(null==t?void 0:null===(o=t.marks)||void 0===o?void 0:o.find(t=>{var e,r,i,l,a;return null===(l=t.attrs)||void 0===l?void 0:null===(i=l[n])||void 0===i?void 0:null===(r=i.trim)||void 0===r?void 0:null===(e=(a=r.call(i)).toLowerCase)||void 0===e?void 0:e.call(a).startsWith("javascript:")})))return!0}return!1})}function e8(t){let e,{postId:r}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if("string"==typeof t){let i=eW(t,{postId:r});if(!i)return null;e=i}else e=t;return(0,ei.f5)(e)?(0,ea.Y)(e,t=>{for(let n of["href","src","url"]){var e,r,i,l,a,o;if((null==t?void 0:null===(l=t.attrs)||void 0===l?void 0:null===(i=l[n])||void 0===i?void 0:null===(r=i.trim)||void 0===r?void 0:null===(e=(a=r.call(i)).toLowerCase)||void 0===e?void 0:e.call(a).startsWith("javascript:"))||(null==t?void 0:null===(o=t.marks)||void 0===o?void 0:o.find(t=>{var e,r,i,l,a;return null===(l=t.attrs)||void 0===l?void 0:null===(i=l[n])||void 0===i?void 0:null===(r=i.trim)||void 0===r?void 0:null===(e=(a=r.call(i)).toLowerCase)||void 0===e?void 0:e.call(a).startsWith("javascript:")})))return!1}return!0}):(0,ea.Y)(e,t=>{for(let n of["href","src","url"]){var e,r,i,l,a,o;if((null==t?void 0:null===(l=t.attrs)||void 0===l?void 0:null===(i=l[n])||void 0===i?void 0:null===(r=i.trim)||void 0===r?void 0:null===(e=(a=r.call(i)).toLowerCase)||void 0===e?void 0:e.call(a).startsWith("javascript:"))||(null==t?void 0:null===(o=t.marks)||void 0===o?void 0:o.find(t=>{var e,r,i,l,a;return null===(l=t.attrs)||void 0===l?void 0:null===(i=l[n])||void 0===i?void 0:null===(r=i.trim)||void 0===r?void 0:null===(e=(a=r.call(i)).toLowerCase)||void 0===e?void 0:e.call(a).startsWith("javascript:")})))return!1}return!0})}function e5(t){let e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:8,{postId:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i="string"==typeof t?eW(t,{postId:r}):t;if(!i)return;let l=!1;return"doc"===i.type&&i.content&&i.content.map((t,r)=>{r>e?(0,el.cb)(t,t=>{!t.content&&t.attrs&&(t.attrs.belowTheFold=!0)}):l||(0,el.cb)(t,t=>{!t.content&&(null==t?void 0:t.type)=="image2"&&t.attrs&&(t.attrs.topImage=!0,l=!0)})}),i}function e6(t){let{postId:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};try{return JSON.parse(t),eU(t,{postId:e})}catch(e){return t}}function e7(t,e){let{body:r,hasPodcastPreview:i}=e;if(!t||!r)return null;let l=r;return i&&(l=JSON.stringify((0,el.N5)(eW(r,{postId:t.id}),{maxLength:"post_preview_limit"in t&&t.post_preview_limit&&"number"==typeof t.post_preview_limit?t.post_preview_limit:356}))),eU(l,{postId:t.id})}function rt(t){return eC(ek.node("doc",null,t.split("\n").map(t=>t.trim()).filter(t=>t.length>0).map(t=>{let e=[],r=(0,D.m)(t);if(r.length>0){let i=t;for(;;){let t=r.map(t=>[i.indexOf(t.value),t.value]).sort().find(t=>{let[e]=t;return e>=0});if(!t)break;let[l,a]=t;if(l>0&&e.push(ek.text(i.substring(0,l))),!ek.marks.link){console.error("link is missing from schema");continue}e.push(ek.text(a,[ek.marks.link.create({title:a,href:a,target:"_blank"})])),i=i.substring(l+a.length)}i&&e.push(ek.text(i))}else e.push(ek.text(t));return ek.node("paragraph",null,e)})))}function re(t){let{postId:e}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!t)return!1;let r=t;if("string"==typeof t){let i=eW(t,{postId:e});if(!i)return!1;r=i}else r=t;return(0,el.C4)(r)}Object.entries(eO.nodes).forEach(t=>{let[e,r]=t;void 0!==ey[e]&&(r.spec=(0,i._)({},ey[e],r.spec))})}}]);